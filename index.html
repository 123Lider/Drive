<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniDrive User</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg:#e0e5ec; --text:#4a4a4a; --accent:#2d8cf0; --danger:#eb3b5a; --success:#20bf6b; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',sans-serif; outline:none; -webkit-tap-highlight-color:transparent; user-select:none; }
        body { background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }
        
        /* Neu Elements */
        .neu-box { background:var(--bg); box-shadow:9px 9px 16px #a3b1c6, -9px -9px 16px #ffffff; border-radius:20px; }
        .neu-inset { background:var(--bg); box-shadow:inset 6px 6px 10px #a3b1c6, inset -6px -6px 10px #ffffff; border-radius:15px; border:none; }
        .neu-btn { background:var(--bg); box-shadow:6px 6px 10px #a3b1c6, -6px -6px 10px #ffffff; border-radius:50px; border:none; color:var(--accent); font-weight:bold; cursor:pointer; display:flex; justify-content:center; align-items:center; transition:0.2s; }
        .neu-btn:active { box-shadow:inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff; transform: translateY(2px); }
        .neu-input { width:100%; padding:15px; color:var(--text); font-size:14px; }

        /* Dashboard Layout */
        #dashboard { display:none; height:100%; flex-direction:column; }
        header { padding:15px 25px; display:flex; justify-content:space-between; align-items:center; z-index: 10; }
        
        .storage-area { padding:0 25px; margin-bottom:10px; }
        .prog-track { height:8px; border-radius:4px; background:#cbd2d9; overflow:hidden; }
        .prog-fill { height:100%; background:var(--accent); width:0%; transition:0.5s; }
        .path-bar { padding:0 25px; font-size:12px; color:#888; margin-bottom:10px; display:flex; gap:10px; align-items:center; }

        /* --- FIXED GRID SYSTEM (No Overlapping) --- */
        #file-grid { 
            flex:1; 
            overflow-y:auto; 
            padding:20px; 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* Strictly 2 Columns */
            grid-auto-rows: 140px; /* Fixed Height for all rows */
            gap: 15px; 
            align-content: start; 
        }

        .file-card { 
            background: var(--bg);
            box-shadow: 6px 6px 10px #a3b1c6, -6px -6px 10px #ffffff;
            border-radius: 15px;
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            padding:10px; 
            height:100%; /* Fill the grid row */
            width: 100%;
            justify-content:space-between; 
            position:relative; 
            overflow: hidden;
        }
        .file-card.selected { border:2px solid var(--accent); }

        .thumb-wrapper { 
            width:100%; 
            height:90px; 
            border-radius:12px; 
            overflow:hidden; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            background:#d1d9e6; 
            position: relative;
        }
        .file-thumb { width:100%; height:100%; object-fit:cover; }
        .file-icon { font-size:40px; }
        
        .type-badge {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 6px; border-radius: 5px; font-size: 10px;
        }

        /* Upload Progress Overlay */
        .upload-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; font-weight: bold; font-size: 14px;
            z-index: 5;
        }

        .file-name { font-size:11px; font-weight: 600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; text-align:center; margin-top: 5px; }

        /* FAB */
        .fab-container { position:fixed; bottom:30px; right:30px; display:flex; flex-direction:column; gap:15px; align-items:center; z-index: 20; }
        .fab { width:50px; height:50px; font-size:20px; border-radius:50%; }

        /* FULLSCREEN VIEWERS */
        .fullscreen-viewer {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--bg); z-index:2000; flex-direction:column; 
            justify-content:center; align-items:center;
        }
        
        #main-video { width:100%; max-height:60vh; border-radius: 10px; box-shadow: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff; background: #000; }
        #main-photo { max-width: 95%; max-height: 65vh; border-radius: 10px; box-shadow: 10px 10px 20px #a3b1c6, -10px -10px 20px #ffffff; object-fit: contain; }

        .viewer-controls {
            width: 90%; margin-top: 20px; padding: 15px; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Next/Prev Buttons */
        .nav-btns { display: flex; gap: 20px; margin-top: 15px; }
        .nav-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--bg); box-shadow: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff; color: var(--text); font-size: 18px; }
        .nav-btn:active { box-shadow: inset 3px 3px 6px #a3b1c6, inset -3px -3px 6px #ffffff; }

        .vid-seeker {
            -webkit-appearance: none; width: 100%; height: 8px; background: var(--bg);
            box-shadow: inset 3px 3px 6px #a3b1c6, inset -3px -3px 6px #ffffff;
            border-radius: 10px; margin-bottom: 15px;
        }
        .vid-seeker::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer;
        }

        /* Modals & Chat */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); backdrop-filter:blur(5px); z-index:999; justify-content:center; align-items:center; }
        .modal { width:300px; padding:25px; text-align:center; position:relative; }
        .notif-dot { position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; font-size:10px; padding:3px 6px; border-radius:10px; display:none; }
        .popup-icon { font-size:40px; margin-bottom:15px; }
        .pop-success { color:var(--success); } .pop-error { color:var(--danger); } .pop-info { color:var(--accent); }
        .modal-btns { display:flex; gap:15px; margin-top:20px; } .modal-btns button { flex:1; padding:10px; }
        
        #chat-msgs { height:200px; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
        .msg { padding:8px 12px; border-radius:10px; font-size:12px; max-width:85%; word-wrap:break-word; }
        .msg-me { background:var(--accent); color:white; align-self:flex-end; border-bottom-right-radius:0; }
        .msg-admin { background:#d1d9e6; color:black; align-self:flex-start; border-bottom-left-radius:0; }

        /* Auth & Scan */
        #auth-screen { display:flex; justify-content:center; align-items:center; height:100%; }
        .auth-card { width:320px; padding:30px; text-align:center; display:flex; flex-direction:column; gap:15px; }
        #cam-box { position:relative; width:100%; height:300px; display:none; background:#000; border-radius:15px; overflow:hidden; }
        #webcam { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
        .scan-overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; pointer-events:none; }
        .face-frame { width:180px; height:230px; border:2px dashed rgba(255,255,255,0.5); border-radius:50%; transition:0.3s; }
        .face-frame.valid { border-color:var(--success); border-style:solid; box-shadow:0 0 20px var(--success); }
        .face-frame.error { border-color:var(--danger); border-style:solid; box-shadow:0 0 20px var(--danger); }
        #scan-status { color:white; margin-top:10px; font-weight:bold; text-shadow:0 1px 3px black; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:10px; }
        #prog-bar { width:60%; height:6px; background:rgba(255,255,255,0.3); border-radius:10px; margin-top:10px; overflow:hidden; display:none; }
        #prog-fill { width:0%; height:100%; background:var(--success); transition:width 0.1s linear; }
    </style>
</head>
<body>

    <!-- AUTH -->
    <div id="auth-screen">
        <div class="neu-box auth-card">
            <h2 style="color:var(--text);">MiniDrive</h2>
            <div id="login-form">
                <input type="email" id="l-email" class="neu-inset neu-input" placeholder="Gmail" style="margin-bottom:15px;">
                <input type="password" id="l-pass" class="neu-inset neu-input" placeholder="Password" style="margin-bottom:15px;">
                <button class="neu-btn" style="width:100%; padding:15px;" onclick="window.login()">Log In</button>
                <p style="margin-top:15px; font-size:12px; cursor:pointer;" onclick="window.toggleAuth('signup')">Create Account</p>
            </div>
            <div id="signup-form" style="display:none;">
                <div id="s-inputs">
                    <input type="text" id="r-name" class="neu-inset neu-input" placeholder="Name" style="margin-bottom:10px;">
                    <input type="email" id="r-email" class="neu-inset neu-input" placeholder="Gmail" style="margin-bottom:10px;">
                    <input type="password" id="r-pass" class="neu-inset neu-input" placeholder="Password" style="margin-bottom:10px;">
                    <button class="neu-btn" style="width:100%; padding:15px; margin-top:10px;" onclick="window.startCam()">Next</button>
                    <p style="margin-top:15px; font-size:12px; cursor:pointer;" onclick="window.toggleAuth('login')">Back to Login</p>
                </div>
                <div id="cam-box">
                    <video id="webcam" autoplay playsinline></video>
                    <canvas id="scan-canvas" style="display:none;"></canvas>
                    <div class="scan-overlay">
                        <div class="face-frame" id="face-frame"></div>
                        <div id="scan-status">Position Face</div>
                        <div id="prog-bar"><div id="prog-fill"></div></div>
                    </div>
                </div>
                <button id="cancel-scan" class="neu-btn" style="width:100%; margin-top:10px; display:none;" onclick="location.reload()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <header class="neu-box" style="border-radius:0 0 20px 20px;">
            <div style="font-size:12px; font-weight:bold; color:var(--accent); cursor:pointer;" onclick="window.copyUID()" id="uid-disp">UID...</div>
            <div style="display:flex; gap:15px;">
                <div style="position:relative;" onclick="window.openModal('notif-modal'); window.loadNotifs();">
                    <button class="neu-btn" style="width:35px; height:35px;"><i class="fas fa-bell"></i></button>
                    <div id="notif-dot" class="notif-dot">0</div>
                </div>
                <div style="position:relative;" onclick="window.openChat()">
                    <button class="neu-btn" style="width:35px; height:35px;"><i class="fas fa-comment-dollar"></i></button>
                    <div id="chat-badge" class="notif-dot" style="background:#20bf6b; width:18px; height:18px; top:-5px; right:-5px; display:none; justify-content:center; align-items:center;">0</div>
                </div>
                <button class="neu-btn" style="width:35px; height:35px; color:var(--danger);" onclick="window.logout()"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div class="storage-area">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:5px;"><span>Storage</span><span id="store-txt">...</span></div>
            <div class="prog-track neu-inset"><div class="prog-fill" id="store-bar"></div></div>
        </div>

        <div class="path-bar" id="path-bar" style="display:none;">
            <i class="fas fa-arrow-left" onclick="window.goBack()" style="cursor:pointer; color:var(--text);"></i>
            <span id="curr-folder">/ Home</span>
        </div>

        <div id="file-grid"></div>

        <div class="fab-container">
            <input type="file" id="file-in" hidden multiple onchange="window.uploadFilesXHR(this)">
            <div id="sel-actions" style="display:none; gap:10px; flex-direction:column;">
                <button class="neu-btn fab" style="color:var(--danger);" onclick="window.openPopup('confirm','Delete selected?', 'warning', window.deleteSelected)"><i class="fas fa-trash"></i></button>
                <button class="neu-btn fab" style="color:var(--success);" onclick="window.downloadSelected()"><i class="fas fa-download"></i></button>
                <button class="neu-btn fab" onclick="window.openModal('share-modal')"><i class="fas fa-paper-plane"></i></button>
            </div>
            <button class="neu-btn fab" style="color:#f7b731;" onclick="window.openModal('folder-modal')"><i class="fas fa-folder-plus"></i></button>
            <button class="neu-btn fab" onclick="document.getElementById('file-in').click()"><i class="fas fa-cloud-upload-alt"></i></button>
        </div>
    </div>

    <!-- VIDEO PLAYER UI (With Next/Prev) -->
    <div id="custom-player" class="fullscreen-viewer">
        <video id="main-video" playsinline></video>
        <div class="neu-box viewer-controls" style="flex-direction:column; align-items:stretch;">
            <input type="range" id="vid-seek" class="vid-seeker" value="0" step="0.1">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="neu-btn" style="width:50px; height:50px;" onclick="window.closeVideoPlayer()"><i class="fas fa-arrow-left"></i></button>
                <button id="play-btn" class="neu-btn" style="width:60px; height:60px; font-size:25px;" onclick="window.toggleVideo()"><i class="fas fa-play"></i></button>
                <div class="vid-time" id="vid-time-txt" style="font-weight:bold; color:#888;">00:00</div>
            </div>
        </div>
        <div class="nav-btns">
            <button class="nav-btn" onclick="window.prevMedia()"><i class="fas fa-chevron-left"></i></button>
            <button class="nav-btn" onclick="window.nextMedia()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- PHOTO VIEWER UI (With Next/Prev) -->
    <div id="photo-viewer" class="fullscreen-viewer">
        <img id="main-photo" src="">
        <div class="neu-box viewer-controls" style="width: auto; padding: 10px 30px; margin-top: 20px;">
            <button class="neu-btn" onclick="window.closePhotoViewer()"><i class="fas fa-arrow-left"></i> Back</button>
        </div>
        <div class="nav-btns">
            <button class="nav-btn" onclick="window.prevMedia()"><i class="fas fa-chevron-left"></i></button>
            <button class="nav-btn" onclick="window.nextMedia()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- GLOBAL POPUP -->
    <div id="global-popup" class="modal-overlay">
        <div class="modal neu-box">
            <i id="pop-icon" class="fas fa-info-circle popup-icon"></i>
            <h3 id="pop-title">Alert</h3>
            <p id="pop-msg" style="font-size:13px; color:#666; margin-bottom:20px;"></p>
            <div class="modal-btns">
                <button id="pop-cancel" class="neu-btn" style="display:none;">Cancel</button>
                <button id="pop-ok" class="neu-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="folder-modal" class="modal-overlay"><div class="modal neu-box"><h3>New Folder</h3><input id="new-fold-name" class="neu-inset neu-input"><div class="modal-btns"><button class="neu-btn" onclick="window.closeModal('folder-modal')">Cancel</button><button class="neu-btn" onclick="window.createFolder()">Create</button></div></div></div>
    <div id="share-modal" class="modal-overlay"><div class="modal neu-box"><h3>Share</h3><input id="share-uid" class="neu-inset neu-input" placeholder="Receiver UID"><div class="modal-btns"><button class="neu-btn" onclick="window.closeModal('share-modal')">Cancel</button><button class="neu-btn" onclick="window.shareFiles()">Send</button></div></div></div>
    <div id="chat-modal" class="modal-overlay"><div class="modal neu-box" style="width:350px; padding:15px;"><h3>Storage Support</h3><div id="chat-msgs" class="neu-inset"></div><div style="display:flex; gap:5px; margin-top:10px;"><input id="chat-in" class="neu-inset neu-input" placeholder="Type here..."><button class="neu-btn" style="width:50px;" onclick="window.sendChat()"><i class="fas fa-paper-plane"></i></button></div><button class="neu-btn" style="width:100%; margin-top:10px;" onclick="window.closeModal('chat-modal')">Close</button></div></div>
    <div id="notif-modal" class="modal-overlay"><div class="modal neu-box"><h3>Inbox</h3><div id="notif-list" style="max-height:200px; overflow-y:auto; text-align:left;"></div><button class="neu-btn" style="width:100%; margin-top:20px;" onclick="window.closeModal('notif-modal')">Close</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { apiKey:"AIzaSyCVdE_D4zcQbv-ifeVAaP_XTn3aLHNSctk", authDomain:"minidrive-49a74.firebaseapp.com", databaseURL:"https://minidrive-49a74-default-rtdb.firebaseio.com", projectId:"minidrive-49a74", storageBucket:"minidrive-49a74.firebasestorage.app", messagingSenderId:"582882194063", appId:"1:582882194063:web:1d8e81d789e64e9fe2b6fa" };
    const app = initializeApp(config); const auth = getAuth(app); const db = getDatabase(app);
    const DEF_CLOUD="dhfbdy7rq", DEF_PRESET="MiniDrive";
    let curUser=null, myUID="", selFiles=new Set(), curFold='root', foldPath=[{id:'root',name:'Home'}];
    let popupCb = null;
    let currentMediaList = []; // For Next/Prev
    let currentMediaIndex = 0;
    let filesListenerAttached = false;
    let longPressTimer = null;
	let isLongPress = false;
	let dbSnapshot = null;

    // --- GLOBAL ---
    window.openPopup = (type, msg, status='info', cb=null) => {
        const p=document.getElementById('global-popup'), i=document.getElementById('pop-icon'), t=document.getElementById('pop-title'), m=document.getElementById('pop-msg'), o=document.getElementById('pop-ok'), c=document.getElementById('pop-cancel');
        popupCb = cb;
        t.innerText = type==='confirm'?"Confirmation":(status==='success'?"Success":"Alert"); m.innerText = msg;
        i.className = `fas popup-icon ${status==='success'?'fa-check-circle pop-success':(status==='error'?'fa-times-circle pop-error':'fa-info-circle pop-info')}`;
        c.style.display=type==='confirm'?'inline-block':'none';
        o.onclick=()=>{ p.style.display='none'; if(popupCb) popupCb(); };
        c.onclick=()=>{ p.style.display='none'; };
        p.style.display='flex';
    };

    window.toggleAuth=(m)=>{ document.getElementById('login-form').style.display=m==='login'?'block':'none'; document.getElementById('signup-form').style.display=m==='signup'?'block':'none'; };
    window.openModal=id=>document.getElementById(id).style.display='flex'; 
    window.closeModal=id=>document.getElementById(id).style.display='none';

    // AUTH
    onAuthStateChanged(auth, u=>{ if(u){ curUser=u; init(); } else{ document.getElementById('auth-screen').style.display='flex'; document.getElementById('dashboard').style.display='none'; } });
    window.login=async()=>{ try{ await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value); } catch(e){ window.openPopup('alert', parseError(e.message), 'error'); } };
    function parseError(msg) { if(msg.includes("user-not-found")) return "User not found"; if(msg.includes("wrong-password")) return "Wrong Password"; return msg; }
    
    // FACE SCAN
    window.startCam=async()=>{
        const n=document.getElementById('r-name').value, p=document.getElementById('r-pass').value, e=document.getElementById('r-email').value;
        if(!n||!p||!e) return window.openPopup('alert',"Fill all fields",'error');
        document.getElementById('s-inputs').style.display='none'; document.getElementById('cam-box').style.display='block'; document.getElementById('cancel-scan').style.display='block';
        const s = await navigator.mediaDevices.getUserMedia({video:true}); document.getElementById('webcam').srcObject = s; analyzeFace();
    };
    function analyzeFace() {
        const video=document.getElementById('webcam'), canvas=document.getElementById('scan-canvas'), ctx=canvas.getContext('2d'), status=document.getElementById('scan-status'), frame=document.getElementById('face-frame'), bar=document.getElementById('prog-bar'), fill=document.getElementById('prog-fill');
        let progress = 0;
        const scanInterval = setInterval(() => {
            if(video.readyState===video.HAVE_ENOUGH_DATA) {
                canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0,canvas.width,canvas.height);
                const fd=ctx.getImageData(canvas.width/2-20,canvas.height/2-20,40,40);
                let r=0, g=0, b=0; for(let i=0;i<fd.data.length;i+=4){r+=fd.data[i];g+=fd.data[i+1];b+=fd.data[i+2];}
                if(Math.floor((r+g+b)/(fd.data.length/4*3))<40){ status.innerText="Too Dark!"; status.style.color="#eb3b5a"; frame.className="face-frame error"; }
                else{ status.innerText="Scanning..."; status.style.color="#20bf6b"; frame.className="face-frame valid"; bar.style.display="block"; progress+=1.5; fill.style.width=progress+"%"; if(progress>=100){ clearInterval(scanInterval); status.innerText="Processing..."; uploadFace(canvas); }}
            }
        },50);
    }
    async function uploadFace(canvas){
        const b=await(await fetch(canvas.toDataURL('image/jpeg'))).blob(), fd=new FormData(); fd.append('file',b); fd.append('upload_preset',DEF_PRESET);
        try{ const r=await fetch(`https://api.cloudinary.com/v1_1/${DEF_CLOUD}/upload`,{method:'POST',body:fd}); const d=await r.json(); createAcc(d.secure_url); } catch(e){ window.openPopup('alert',"Error",'error',()=>location.reload()); }
    }
    async function createAcc(face){
        const e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value, n=document.getElementById('r-name').value;
        const cid=`TD${Math.floor(Math.random()*90000000+10000000)}${n.slice(0,2).toUpperCase()}`;
        try{ const c=await createUserWithEmailAndPassword(auth,e,p); await set(ref(db,`users/${c.user.uid}`),{name:n,email:e,customUID:cid,faceUrl:face,storageLimitGB:15,usedStorageBytes:0}); await set(ref(db,`uid_map/${cid}`),c.user.uid); location.reload(); } catch(e){ window.openPopup('alert',parseError(e.message),'error'); }
    }

    // MAIN
    function init() {
    // screen switch
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'flex';

    // USER DATA LISTENER
    onValue(ref(db, `users/${curUser.uid}`), async (snapshot) => {
        if (!snapshot.exists()) return;

        const u = snapshot.val();

        // à¦¯à¦¦à¦¿ customUID à¦¨à¦¾ à¦¥à¦¾à¦•à§‡ â†’ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¬à§‡
        if (!u.customUID) {
            const namePart = (u.name || "US").slice(0, 2).toUpperCase();
            const rand = Math.floor(Math.random() * 90000000 + 10000000);
            const newCID = `TD${rand}${namePart}`;

            await update(ref(db, `users/${curUser.uid}`), {
                customUID: newCID,
                storageLimitGB: u.storageLimitGB ?? 15,
                usedStorageBytes: u.usedStorageBytes ?? 0
            });

            await set(ref(db, `uid_map/${newCID}`), curUser.uid);
            return;
        }

        // UID à¦¦à§‡à¦–à¦¾à¦¨à§‹
        myUID = u.customUID;
        document.getElementById('uid-disp').innerText = "UID: " + myUID;

        // STORAGE CALCULATION
        const limit = u.storageLimitGB ?? 15;
        const usedBytes = u.usedStorageBytes ?? 0;
        const usedGB = usedBytes / (1024 ** 3);
        const usedGBText = usedGB.toFixed(2);

        document.getElementById('store-txt').innerText =
            `${usedGBText} / ${limit} GB`;

        const percent = Math.min((usedGB / limit) * 100, 100);
        document.getElementById('store-bar').style.width = percent + "%";
    });

    // NOTIFICATION DOT
    onValue(ref(db, `users/${curUser.uid}/notifications`), (snapshot) => {
        const dot = document.getElementById('notif-dot');
        const count = snapshot.exists() ? snapshot.size : 0;

        if (count > 0) {
            dot.style.display = 'block';
            dot.innerText = count;
        } else {
            dot.style.display = 'none';
        }
    });

    // ADMIN CHAT BADGE
    onValue(ref(db, `admin_requests/${curUser.uid}/messages`), (snapshot) => {
        let unread = 0;

        if (snapshot.exists()) {
            snapshot.forEach(child => {
                const msg = child.val();
                if (msg.sender === 'admin' && !msg.userRead) unread++;
            });
        }

        const badge = document.getElementById('chat-badge');
        if (unread > 0) {
            badge.style.display = 'flex';
            badge.innerText = unread;
        } else {
            badge.style.display = 'none';
        }
    });

    // FILE LOAD
    loadFiles();
}

    // --- UPLOAD WITH XHR (PROGRESS BAR) ---
    window.uploadFilesXHR = async (inp) => {
        const files = inp.files; if(files.length===0) return;
        let cN=DEF_CLOUD, cP=DEF_PRESET;
        const s=await get(ref(db,'admin_settings/active_cloud')); if(s.exists()){ cN=s.val().name; cP=s.val().preset; }

        for(const f of files) {
            // Create Placeholder in Grid
            const tempId = "temp-" + Date.now();
            const g = document.getElementById('file-grid');
            const el = document.createElement('div'); el.className = "file-card"; el.id = tempId;
            el.innerHTML = `<div class="thumb-wrapper"><i class="fas fa-spinner fa-spin file-icon"></i></div><span class="file-name">${f.name}</span><div class="upload-overlay" id="prog-${tempId}">0%</div>`;
            g.insertBefore(el, g.firstChild);

            // Upload using XHR
            const fd = new FormData(); fd.append('file',f); fd.append('upload_preset',cP);
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `https://api.cloudinary.com/v1_1/${cN}/upload`);

            xhr.upload.onprogress = (e) => {
                const percent = Math.round((e.loaded / e.total) * 100);
                const pEl = document.getElementById(`prog-${tempId}`);
                if(pEl) pEl.innerText = percent + "%";
            };

            xhr.onload = async () => {
                if(xhr.status === 200) {
                    const d = JSON.parse(xhr.responseText);
                    const t = f.type.startsWith('image')?'image':(f.type.startsWith('video')?'video':'file');
                    // Save to DB
                    await push(ref(db,`users/${curUser.uid}/files`),{name:f.name,url:d.secure_url,type:t,size:d.bytes,createdAt:Date.now(),parentId:curFold});
                    // Update Storage
                    const us = await get(ref(db,`users/${curUser.uid}/usedStorageBytes`));
                    update(ref(db,`users/${curUser.uid}`), {usedStorageBytes:(us.val()||0)+d.bytes});
                    // Remove Placeholder (DB listener will render real file)
                    const el = document.getElementById(tempId); if(el) el.remove();
                } else {
                    document.getElementById(tempId).remove();
                    window.openPopup('alert', "Upload Failed: " + f.name, 'error');
                }
            };
            xhr.send(fd);
        }
        inp.value = ""; // Reset input
    };

    window.createFolder=()=>{ const n=document.getElementById('new-fold-name').value; if(n){ push(ref(db,`users/${curUser.uid}/files`),{name:n,type:'folder',parentId:curFold,createdAt:Date.now()}); document.getElementById('new-fold-name').value=""; window.closeModal('folder-modal'); } };

    // --- DELETE WITH STORAGE RECLAIM ---
    window.deleteSelected = async () => {
        let totalBytesFreed = 0;
        for (const k of selFiles) {
            const fRef = ref(db, `users/${curUser.uid}/files/${k}`);
            const snap = await get(fRef);
            if (snap.exists()) {
                const f = snap.val();
                if(f.size) totalBytesFreed += f.size;
                await remove(fRef);
            }
        }
        // Update Storage Limit
        const us = await get(ref(db, `users/${curUser.uid}/usedStorageBytes`));
        let current = us.val() || 0;
        let newSize = current - totalBytesFreed;
        if(newSize < 0) newSize = 0;
        await update(ref(db, `users/${curUser.uid}`), { usedStorageBytes: newSize });

        selFiles.clear(); 
        document.getElementById('sel-actions').style.display='none'; 
        document.getElementById('global-popup').style.display='none';
    };

function loadFiles(){
    if(filesListenerAttached) return;
    filesListenerAttached = true;

    onValue(ref(db,`users/${curUser.uid}/files`), snapshot=>{
        dbSnapshot = snapshot;   // âœ… à¦à¦–à¦¾à¦¨à§‡à¦‡ à¦¸à§‡à¦­
        renderFiles(snapshot);
    });
}

function renderFiles(snapshot){
    const g = document.getElementById('file-grid');
    g.innerHTML = "";

    if(!snapshot) return;

    const allFiles = [];
    snapshot.forEach(c=>{
        allFiles.push({ k:c.key, ...c.val() });
    });

    const visibleFiles = allFiles.filter(
        f => (f.parentId ?? 'root') === curFold
    );

    visibleFiles.sort((a,b)=>{
        if(a.type==='folder' && b.type!=='folder') return -1;
        if(a.type!=='folder' && b.type==='folder') return 1;
        return (b.createdAt||0)-(a.createdAt||0);
    });

    currentMediaList = visibleFiles.filter(
        f => f.type==='image' || f.type==='video'
    );

    visibleFiles.forEach(f=>{
        const el = document.createElement('div');
        el.className = "file-card";

        let thumb = "";
        if(f.type === 'folder'){
            thumb = `<i class="fas fa-folder file-icon" style="color:#f7b731"></i>`;
        }else if(f.type === 'image'){
            thumb = `<img src="${f.url}" class="file-thumb">`;
        }else if(f.type === 'video'){
            const thumbUrl = f.url
                .replace('/video/upload/', '/video/upload/so_1/')
                .replace('.mp4', '.jpg');

            thumb = `
                <img src="${thumbUrl}" class="file-thumb">
                <div class="type-badge">VIDEO</div>
            `;
        }else{
            thumb = `<i class="fas fa-file file-icon"></i>`;
        }

        el.innerHTML = `
            <div class="thumb-wrapper">${thumb}</div>
            <span class="file-name">${f.name}</span>
        `;

        // ===== TOUCH SYSTEM =====
        let pressTimer = null;
        let longPressed = false;

        el.addEventListener("touchstart", () => {
            longPressed = false;
            pressTimer = setTimeout(() => {
                longPressed = true;
                togSel(f.k, el);
                navigator.vibrate?.(40);
            }, 500);
        });

        el.addEventListener("touchend", () => {
            clearTimeout(pressTimer);

            if(longPressed) return;

            if(selFiles.size > 0){
                togSel(f.k, el);
                return;
            }

            // âœ… NORMAL CLICK
            if (f.type === 'folder') nav(f.k, f.name);
            else if (f.type === 'image') viewPhoto(f.url, f.k);
            else if (f.type === 'video') playVideoInApp(f.url, f.k);
            else window.open(f.url);
        });

        el.addEventListener("touchmove", () => clearTimeout(pressTimer));
        // ========================

        g.appendChild(el);
    });
}

    // --- NEXT / PREV LOGIC ---
    function findMediaIndex(key) { return currentMediaList.findIndex(m => m.k === key); }
    
    window.nextMedia = () => {
        if(currentMediaList.length === 0) return;
        currentMediaIndex = (currentMediaIndex + 1) % currentMediaList.length;
        openMediaByIndex(currentMediaIndex);
    };

    window.prevMedia = () => {
        if(currentMediaList.length === 0) return;
        currentMediaIndex = (currentMediaIndex - 1 + currentMediaList.length) % currentMediaList.length;
        openMediaByIndex(currentMediaIndex);
    };

    function openMediaByIndex(idx) {
        const item = currentMediaList[idx];
        if(item.type === 'video') {
            window.closePhotoViewer();
            window.playVideoInApp(item.url, item.k, false); // false = don't reset index
        } else if (item.type === 'image') {
            window.closeVideoPlayer();
            window.viewPhoto(item.url, item.k, false);
        }
    }

    // --- VIEWERS ---
    window.viewPhoto = (url, key, resetIndex=true) => {
        if(resetIndex) currentMediaIndex = findMediaIndex(key);
        document.getElementById('main-photo').src = url;
        document.getElementById('photo-viewer').style.display = 'flex';
    };
    window.closePhotoViewer = () => { document.getElementById('photo-viewer').style.display = 'none'; document.getElementById('main-photo').src = ""; };

    window.playVideoInApp = (url, key, resetIndex=true) => {
        if(resetIndex) currentMediaIndex = findMediaIndex(key);
        const p=document.getElementById('custom-player'), v=document.getElementById('main-video'), s=document.getElementById('vid-seek');
        v.src = url; p.style.display = 'flex'; v.play();
        document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
        v.ontimeupdate=()=>{ s.value=(v.currentTime/v.duration)*100; let m=Math.floor(v.currentTime/60), sec=Math.floor(v.currentTime%60); document.getElementById('vid-time-txt').innerText=`${m}:${sec<10?'0':''}${sec}`; };
        s.oninput=()=>{ v.currentTime=(s.value/100)*v.duration; };
    };
    window.toggleVideo=()=>{ const v=document.getElementById('main-video'), b=document.getElementById('play-btn'); if(v.paused){ v.play(); b.innerHTML='<i class="fas fa-pause"></i>'; } else { v.pause(); b.innerHTML='<i class="fas fa-play"></i>'; } };
    window.closeVideoPlayer=()=>{ document.getElementById('custom-player').style.display='none'; document.getElementById('main-video').pause(); document.getElementById('main-video').src=""; };

    // --- DOWNLOAD ---
    window.downloadSelected=()=>{ selFiles.forEach(async k=>{ const f=(await get(ref(db,`users/${curUser.uid}/files/${k}`))).val(); fetch(f.url).then(r=>r.blob()).then(b=>{const u=window.URL.createObjectURL(b), a=document.createElement('a'); a.style.display='none'; a.href=u; a.download=f.name; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(u);}).catch(()=>window.open(f.url)); }); selFiles.clear(); document.getElementById('sel-actions').style.display='none'; };
    
    // NAVIGATION
    function togSel(k,el){ if(selFiles.has(k)){selFiles.delete(k);el.classList.remove('selected');}else{selFiles.add(k);el.classList.add('selected');} document.getElementById('sel-actions').style.display=selFiles.size>0?'flex':'none'; }
    window.nav = (id, name) => {
    curFold = id;
    foldPath.push({ id, name });
    upPath();
    history.pushState({}, ""); // ðŸ‘ˆ back enable
    renderFiles(dbSnapshot);
};

window.goBack = () => { 
    if(curFold === 'root') return;
    foldPath.pop();
    curFold = foldPath[foldPath.length - 1].id;
    upPath();
    renderFiles(dbSnapshot);   // âœ… FIX
};
    function upPath(){ document.getElementById('path-bar').style.display=curFold==='root'?'none':'flex'; document.getElementById('curr-folder').innerText="/ "+foldPath.map(p=>p.name).join(" / "); }
    
    window.addEventListener("popstate", () => {
    if (foldPath.length > 1) {
        foldPath.pop();
        curFold = foldPath[foldPath.length - 1].id;
        upPath();
        renderFiles(dbSnapshot);
    } else {
        navigator.app?.exitApp?.(); // WebView à¦¹à¦²à§‡
    }
});

    // SHARE & NOTIF
    window.shareFiles=async()=>{ const id=document.getElementById('share-uid').value, m=await get(ref(db,`uid_map/${id}`)); if(!m.exists())return window.openPopup('alert',"UID Not Found",'error'); selFiles.forEach(async k=>{const f=(await get(ref(db,`users/${curUser.uid}/files/${k}`))).val(); push(ref(db,`users/${m.val()}/notifications`),{from:myUID,fname:f.name,url:f.url,type:f.type,size:f.size});}); window.openPopup('alert',"Sent!",'success'); window.closeModal('share-modal'); selFiles.clear(); };
    window.loadNotifs=()=>{ const l=document.getElementById('notif-list'); l.innerHTML=""; onValue(ref(db,`users/${curUser.uid}/notifications`),s=>{ l.innerHTML=""; s.forEach(c=>{ const n=c.val(); const d=document.createElement('div'); d.className="neu-inset"; d.style.padding="10px"; d.style.marginBottom="5px"; d.innerHTML=`<small>From ${n.from}</small><br><b>${n.fname}</b><br><button class="neu-btn" style="font-size:10px; margin-top:5px;" onclick="window.acc('${c.key}')">Save</button>`; l.appendChild(d); }); }); };
    window.acc=async(k)=>{ const r=ref(db,`users/${curUser.uid}/notifications/${k}`), n=(await get(r)).val(); await push(ref(db,`users/${curUser.uid}/files`),{name:n.fname,url:n.url,type:n.type,size:n.size,parentId:'root',createdAt:Date.now()}); remove(r); };
    window.copyUID=()=>{navigator.clipboard.writeText(myUID); window.openPopup('alert',"UID Copied",'success');}; window.logout=()=>{signOut(auth); location.reload();}; 
    // CHAT
    window.openChat=()=>{document.getElementById('chat-modal').style.display='flex';const r=ref(db,`admin_requests/${curUser.uid}/messages`);get(r).then(s=>{if(s.exists())s.forEach(c=>{if(c.val().sender==='admin'&&!c.val().userRead)update(ref(db,`admin_requests/${curUser.uid}/messages/${c.key}`),{userRead:true})})});onValue(r,s=>{const d=document.getElementById('chat-msgs');d.innerHTML="";if(s.exists()){s.forEach(c=>{const m=c.val();d.innerHTML+=`<div class="msg ${m.sender==='user'?'msg-me':'msg-admin'}">${m.text}</div>`});d.scrollTop=d.scrollHeight}else{d.innerHTML="<small style='text-align:center;color:gray'>Contact Admin</small>"}})};
    window.sendChat=async()=>{const t=document.getElementById('chat-in').value;if(!t)return;await push(ref(db,`admin_requests/${curUser.uid}/messages`),{sender:'user',text:t,timestamp:Date.now()});const u=await get(ref(db,`users/${curUser.uid}`));await update(ref(db,`admin_requests/${curUser.uid}`),{uid:curUser.uid,email:u.exists()?u.val().email:"User",seen:false,lastMsg:t,timestamp:Date.now()});document.getElementById('chat-in').value=""};
    
    onValue(ref(db,`admin_requests/${curUser.uid}/messages`), snap=>{
    snap.forEach(c=>{
        const msg = c.val();

        if(msg.sender === 'user' && !msg.autoProcessed){
            const match = msg.text.match(/(\d+)\s*gb/i);

            if(match){
                const gb = parseInt(match[1]);
                let price = 0;

                if(gb > 14){
                    price = (gb - 14) * 10;
                }

                push(ref(db,`admin_requests/${curUser.uid}/messages`),{
                    sender: 'admin',
                    text: `${gb} GB storage price: ${price} TK`,
                    timestamp: Date.now(),
                    userRead: false
                });

                update(ref(db,`admin_requests/${curUser.uid}/messages/${c.key}`),{
                    autoProcessed: true
                });
            }
        }
    });
});

</script>
</body>
</html>